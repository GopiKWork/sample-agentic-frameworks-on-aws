{{- $root := . -}}
{{- $ings := .Values.ingresses | default (list) -}}
{{- if gt (len $ings) 0 }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "agent.fullname" . }}-test-connection"
  labels:
    {{- include "agent.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  restartPolicy: Never
  containers:
    - name: smoke
      image: curlimages/curl:8.7.1
      command: ["/bin/sh","-c"]
      args:
        - |
          set -euo pipefail
          {{- range $i, $ing := $ings }}
          {{- $name := default (printf "ingress-%d" $i) $ing.name }}
          {{- $svcName := default (include "agent.fullname" $root) ($ing.service.name | default "") }}
          {{- if and $ing.service $ing.service.port (hasKey $ing.service.port "number") }}
          echo "Testing {{ $name }} -> http://{{ $svcName }}:{{ $ing.service.port.number }}/"
          curl -sS -o /dev/null -f "http://{{ $svcName }}:{{ $ing.service.port.number }}/" || { echo "FAILED: {{ $name }}"; exit 1; }
          {{- else }}
          echo "Skipping {{ $name }}: no numeric service.port.number provided"
          {{- end }}
          {{- end }}
          echo "All connectivity tests passed"
{{- end }}