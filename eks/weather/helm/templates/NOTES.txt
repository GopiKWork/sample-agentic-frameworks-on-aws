{{- $full := include "agent.fullname" . -}}
{{- $ns := .Release.Namespace -}}
{{- $ings := .Values.ingresses | default (list) -}}
{{- $svcType := default "ClusterIP" .Values.service.type -}}

{{- $scheme := "http" -}}
{{- $ic := .Values.ingressClass | default (dict) -}}
{{- $icp := (get $ic "parameters") | default (dict) -}}
{{- $certs := (get $icp "certificateARNs") | default (list) -}}
{{- if gt (len $certs) 0 }}{{- $scheme = "https" -}}{{- end }}

1. Get the application URL by running these commands:
{{- if gt (len $ings) 0 }}

{{- range $i, $ing := $ings }}
{{- if and $ing.hosts (gt (len $ing.hosts) 0) }}
  # {{ default (printf "ingress-%d" $i) $ing.name }}
  {{- range $h := $ing.hosts }}
    {{- range $p := $h.paths }}
  {{ $scheme }}://{{ $h.host }}{{ $p.path }}
    {{- end }}
  {{- end }}
{{- end }}
{{- end }}

{{- /* ingresses: show how to fetch ALB DNS then echo URLs */ -}}
{{- range $i, $ing := $ings }}
{{- if or (not $ing.hosts) (eq (len $ing.hosts) 0) }}
  # {{ default (printf "ingress-%d" $i) $ing.name }} 
  INGRESS_HOST=$(kubectl -n {{ $ns }} get ing {{ printf "%s-%s" $full (default (printf "ingress-%d" $i) $ing.name) | trunc 63 | trimSuffix "-" }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
  {{- $paths := (default (list (dict "path" "/" "pathType" "Prefix")) $ing.paths) }}
  {{- range $p := $paths }}
  echo "{{ $scheme }}://${INGRESS_HOST}}{{ $p.path }}"
  {{- end }}
{{- end }}
{{- end }}

{{- else if contains "NodePort" $svcType }}
  export NODE_PORT=$(kubectl get --namespace {{ $ns }} -o jsonpath="{.spec.ports[0].nodePort}" services {{ $full }})
  export NODE_IP=$(kubectl get nodes --namespace {{ $ns }} -o jsonpath="{.items[0].status.addresses[0].address}")
  echo "NodePort (first port): http://$NODE_IP:$NODE_PORT"

{{- else if contains "LoadBalancer" $svcType }}
     NOTE: It may take a few minutes for the LoadBalancer address to be available.
           You can watch its status by running:
             kubectl get --namespace {{ $ns }} svc -w {{ $full }}
  export SERVICE_ADDR=$(kubectl get svc --namespace {{ $ns }} {{ $full }} -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{.status.loadBalancer.ingress[0].ip}')
  echo "Service LoadBalancer is available at: $SERVICE_ADDR"
  echo "Exposed ports:"
  {{- range $i, $ing := $ings }}
  {{- $pname := (get $ing.service.port "name") | default (printf "port-%d" $i) }}
  {{- $pnum := (get $ing.service.port "number") | default (add 8000 $i) }}
  echo "  - {{ $pname }}: {{ $scheme }}://${SERVICE_ADDR}:{{ $pnum }}"
  {{- end }}

{{- else }}
  echo "Service type is ClusterIP. To access the services, use port-forward:"
  {{- range $i, $ing := $ings }}
  {{- $pname := (get $ing.service.port "name") | default (printf "port-%d" $i) }}
  {{- $pnum := (get $ing.service.port "number") | default (add 30000 $i) }}
  echo "  {{ $pname }}:"
  echo "    kubectl --namespace {{ $ns }} port-forward svc/{{ $full }} {{ $pnum }}:{{ $pname }}"
  {{- end }}
{{- end }}

2. Service details:

  Namespace:  {{ $ns }}
  Service:    {{ $full }}
  Type:       {{ $svcType }}

3. To see the created resources:

  helm get manifest {{ .Release.Name }}